<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cookie Demo: personalization, theme and name</title>
<link rel="stylesheet" href="./cookies.css"/>
</head>
<body>
<div class="wrap">
  <h1>üç™ Cookie demo: personalization, theme and name</h1>
  <p class="lead">Cookies are long‚Äëlived; without cookies it‚Äôs per tab/session. The name shows immediately but is saved only with consent.</p>

  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between">
    <div class="badge">Consent: <b id="consentState">not set</b></div>
        <div class="row">
          <button class="btn primary" id="btnAllow">Allow cookies</button>
          <button class="btn ghost" id="btnDeny">Deny</button>
          <button class="btn danger" id="btnReset">Reset demo</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
      <label for="name">Name for greeting:</label>
      <input id="name" type="text" placeholder="Enter a name"/>
      </div>

      <div class="hr"></div>

      <div class="row">
  <label for="category">Interests (ads):</label>
        <select id="category">
          <option value="" disabled selected>Select a category‚Ä¶</option>
          <option value="travel">Travel</option>
          <option value="sport">Sport</option>
          <option value="tech">Technology</option>
          <option value="mind">Mindfulness</option>
        </select>
      </div>

      <div class="hr"></div>

      <div class="row">
      <label for="theme">Site theme:</label>
        <select id="theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>

      <p class="kvs">
        Cookies: <code>consent</code>, <code>ad_cat</code>, <code>theme</code>, <code>name</code> (with consent).<br/>
        Without cookies: ads preference is stored in <code>sessionStorage.ad_cat_ss</code>, name isn‚Äôt saved.
      </p>
    </section>

    <!--Ad card-->
    <section class="card">
      <div class="badge">ü™ß Ad slot</div>
      <div class="hello" id="hello" aria-live="polite">Hello!</div>
      <div class="ad" id="adSlot"></div>
      <p class="kvs" id="debug"></p>
    </section>
  </div>

  <div class="hr"></div>
  
  
<script>
function escapeName(n){ return n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&'); }
function setCookie(name, value, days){
  const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires = "expires="+ d.toUTCString();
  const secure = location.protocol === "https:" ? "; Secure" : "";
  document.cookie = `${name}=${encodeURIComponent(value)}; ${expires}; path=/; SameSite=Lax${secure}`;
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|; )'+escapeName(name)+'=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}
function delCookie(name){
  const secure = location.protocol === "https:" ? "; Secure" : "";
  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax${secure}`;
}

const ads = {
  travel:{emoji:"üèùÔ∏è",title:"Tours ‚àí20%",text:"Greece, Tbilisi, Dubai ‚Äî closer than you think."},
  sport:{emoji:"üèÉ",title:"ProRun Sneakers",text:"30% lighter ‚Äî faster every km."},
  tech:{emoji:"üíª",title:"Nova 14",text:"Slim, quiet, up to 18 hours of battery."},
  mind:{emoji:"üßò",title:"CalmYou",text:"Meditations and 4‚Äì7‚Äì8 breathing."}
};

const el = {
  consent: document.getElementById('consentState'),
  ad: document.getElementById('adSlot'),
  dbg: document.getElementById('debug'),
  cat: document.getElementById('category'),
  theme: document.getElementById('theme'),
  name: document.getElementById('name'),
  hello: document.getElementById('hello')
};

function getConsent(){ return getCookie('consent'); }

/* cookie || sessionStorage ----- */
function getAdCat(){
  return getConsent()==='1' ? getCookie('ad_cat') : sessionStorage.getItem('ad_cat_ss');
}
function setAdCat(v){
  if (getConsent()==='1') setCookie('ad_cat', v, 365);
  else sessionStorage.setItem('ad_cat_ss', v);
}
function clearAdCat(){
  delCookie('ad_cat'); sessionStorage.removeItem('ad_cat_ss');
}

/* ----- name: always shows, saves if consent=1 ----- */
function updateHelloDisplay(srcVal){
  const name = (srcVal ?? el.name.value ?? '').trim();
  el.hello.textContent = name ? `Hello, ${name}!` : 'Hello!';
}
function loadName(){
  const saved = getConsent()==='1' ? getCookie('name') : null;
  if (saved) el.name.value = saved;
  updateHelloDisplay(saved ?? el.name.value);
}
function maybePersistName(){
  const v = (el.name.value || '').trim();
  if (getConsent()==='1') { v ? setCookie('name', v, 365) : delCookie('name'); }
  updateHelloDisplay(v); //always
}


function migrateSessionToCookiesOnConsent(){
  if (getConsent()!=='1') return;
  const ssCat = sessionStorage.getItem('ad_cat_ss');
  if (ssCat && !getCookie('ad_cat')) setCookie('ad_cat', ssCat, 365);
  const t = el.theme.value;
  if (t) setCookie('theme', t, 365);
  const n = (el.name.value || '').trim();
  if (n) setCookie('name', n, 365);
}

function render(){
  const consent = getConsent();
  const cat = getAdCat();
  const theme = getCookie('theme');

  const effectiveTheme = (consent==='1' && theme==='light') ? 'light' : 'dark';
  document.body.classList.toggle('light', effectiveTheme==='light');
  el.theme.value = effectiveTheme;

  el.consent.textContent = consent==='1' ? 'allowed' : (consent==='0' ? 'denied' : 'not set');


  if (cat && ads[cat]){
    const a = ads[cat];
    el.ad.innerHTML = `<div><div style="font-size:42px">${a.emoji}</div><h3>${a.title}</h3><p class="muted">${a.text}</p>
      <p class="kvs">Preference source: <code>${consent==='1' ? 'cookie: ad_cat' : 'sessionStorage: ad_cat_ss'}</code></p></div>`;
    el.ad.style.display = '';
    el.cat.value = cat;
  } else {
    // ads hidden card, until category is choosen
    el.ad.innerHTML = '';
    el.ad.style.display = 'none';
    el.cat.selectedIndex = 0;
  }

  loadName();

  // Debug
  el.dbg.textContent = "Cookies: " + (document.cookie || "(–ø—É—Å—Ç–æ)") +
    " | sessionStorage.ad_cat_ss: " + (sessionStorage.getItem('ad_cat_ss') ?? "(–ø—É—Å—Ç–æ)");
}

/*handlers*/
document.getElementById('btnAllow').onclick = ()=>{
  setCookie('consent','1',365);
  migrateSessionToCookiesOnConsent(); // cookie migration
  render();
};
document.getElementById('btnDeny').onclick  = ()=>{
  setCookie('consent','0',365);
  clearAdCat(); delCookie('theme'); delCookie('name');
  render();
};

// instant change based on selector
el.cat.addEventListener('change', ()=>{ setAdCat(el.cat.value); render(); });

el.theme.addEventListener('change', ()=>{
  const v = el.theme.value;
  if (getConsent()==='1') setCookie('theme', v, 365);
  document.body.classList.toggle('light', v==='light'); // instant
});
el.name.addEventListener('input', maybePersistName);

document.getElementById('btnReset').onclick = ()=>{
  ['consent','ad_cat','theme','name'].forEach(delCookie);
  sessionStorage.removeItem('ad_cat_ss');
  el.name.value = '';
  render();
};

render();
</script>
 
</body>
</html>
